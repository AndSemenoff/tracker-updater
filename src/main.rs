// src/main.rs

use config::{Config as ConfigBuilder, File};
use tracker_updater::{run_helper, Config};
use std::error::Error;

/// –ì–ª–∞–≤–Ω–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∞—è –æ—à–∏–±–∫–∏
/// –¢–µ–ø–µ—Ä—å –æ–Ω–∞ –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∏ –∑–∞–ø—É—Å–∫
async fn run() -> Result<(), Box<dyn Error>> {
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–≥–µ—Ä–∞ (–∏–∑ –Ω–∞—à–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏)
    tracker_updater::init_logger();

    // 2. –°–±–æ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞
    log::info!("‚öôÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ config.toml...");

    let builder = ConfigBuilder::builder()
        // 1. –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        // .add_source(ConfigBuilder::try_from(&Config::default())?)
        // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ —Ñ–∞–π–ª–∞ `config.toml`. –û–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.
        .add_source(File::with_name("config.toml").required(true));

    // 3. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü–æ–∑–≤–æ–ª—è–µ–º –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ .env –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–¥–∞—Ç—å QBIT_URL –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏, –∏ –æ–Ω –∑–∞–º–µ–Ω–∏—Ç
    // –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞. –ü—Ä–µ—Ñ–∏–∫—Å "APP" (–º–æ–∂–Ω–æ –ª—é–±–æ–π)
    // .add_source(Environment::with_prefix("APP").separator("__"))

    let config: Config = match builder.build() {
        Ok(settings) => match settings.try_deserialize::<Config>() {
            Ok(config) => config,
            Err(e) => {
                log::error!("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {}", e);
                log::error!("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ config.toml –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É.");
                return Err(e.into());
            }
        },
        Err(e) => {
            log::error!("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ config.toml: {}", e);
            log::error!("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª config.toml —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ.");
            return Err(e.into());
        }
    };

    // –í—ã–≤–æ–¥–∏–º –≤ –ª–æ–≥ —á–∞—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥–∞ (–ø–∞—Ä–æ–ª—å –∏ —Å–µ—Å—Å–∏—é –Ω–µ –≤—ã–≤–æ–¥–∏–º!)
    log::debug!(
        "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞: dry_run = {}, qbit.url = {}",
        config.dry_run,
        config.qbit.url
    );
    if config.dry_run {
        log::warn!("--- üü¢ –í–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –ø—Ä–æ–±–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (Dry Run) ---");
        log::warn!("--- üü¢ –ù–∏–∫–∞–∫–∏–µ —Ç–æ—Ä—Ä–µ–Ω—Ç—ã –Ω–µ –±—É–¥—É—Ç –∏–∑–º–µ–Ω–µ–Ω—ã –∏–ª–∏ —É–¥–∞–ª–µ–Ω—ã ---");
    }

    // 4. –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    run_helper(config).await?;

    log::info!("‚úÖ –†–∞–±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.");
    Ok(())
}

// –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
fn main() {
    // –≠—Ç–∞ —á–∞—Å—Ç—å –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    let rt = tokio::runtime::Runtime::new().unwrap();
    rt.block_on(async {
        if let Err(e) = run().await {
            log::error!("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {}", e);
            std::process::exit(1);
        }
    });
}
